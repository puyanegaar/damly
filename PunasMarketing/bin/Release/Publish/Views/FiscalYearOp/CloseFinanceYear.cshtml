@model PunasMarketing.ViewModels.FiscalYearOp.CloseFinanViewmodel
@{
    ViewBag.Title = "بستن دوره مالی";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="layout-content-body">
    <legend>
        بستن دوره مالی
    </legend>
    <div class="col-xs-12 col-md-12" style="margin-top:10px">
        <input type="hidden" id="CurrentFiscalId" value="@Model.Fiscal.Id" />
        <div class="col-xs-1 col-md-1">
            <label class="control-label">از تاریخ</label>
        </div>
        <div class="col-xs-3 col-md-2">
            <label class="control-label">@Model.Fiscal.StartDate.ToPersianDateTime().ToString("yyyy/MM/dd")</label>
        </div>
        <div class="col-xs-1 col-md-1">
            <label class="control-label">تا تاریخ</label>
        </div>
        <div class="col-xs-3 col-md-2">
            <label class="control-label">@Model.Fiscal.EndDate.ToPersianDateTime().ToString("yyyy/MM/dd")</label>
        </div>
        <div class="col-xs-1 col-md-2">
            <label class="control-label">نام مالی دوره جاری</label>
        </div>
        <div class="col-xs-3 col-md-3">
            <label class="control-label">@Model.Fiscal.Name</label>
        </div>
    </div>

    <div class="col-xs-12 col-md-12" style="margin-top:50px">
        <div class="col-xs-1 col-md-1">
            <label class="control-label">از تاریخ</label>
        </div>
        <div class="col-xs-3 col-md-2">
            <input id="StartDate" name="StartDate" class="md-form-control" type="text" value="@Model.StartDate" style="text-align:right" readonly="readonly" />
        </div>
        <div class="col-xs-1 col-md-1">
            <label class="control-label">تا تاریخ</label>
        </div>
        <div class="col-xs-3 col-md-2">
            <input id="EndDate" name="EndDate" class="md-form-control" type="text" style="text-align:right" readonly="readonly" />
        </div>
        <div class="col-xs-1 col-md-2">
            <label class="control-label">نام مالی دوره جدید</label>
        </div>
        <div class="col-xs-3 col-md-3">
            <input id="NewFiscalYear" name="NewFiscalYear" class="md-form-control" type="text" style="text-align:right" readonly="readonly" />
        </div>
    </div>
    <div class="col-xs-12 col-md-12" style="margin-top:50px">
        <div class="col-xs-1 col-md-1">
            <label class="control-label">مالیات</label>
        </div>
        <div class="col-xs-3 col-md-2">
            <input id="Vat" name="Vat" class="md-form-control" type="number"  style="text-align:right" />
        </div>
    </div>

    <div class="col-xs-12 col-md-12" style="border-bottom:1px solid #ddd ; margin-top:20px"></div>

    <div class="col-xs-12 col-md-12" style="margin-top:10px">
        <div class="col-xs-12 col-md-12">
            <div class="card">
                <div class="card-header">
                    <strong>بستن حساب</strong>
                </div>
                <div class="card-body">
                    <table id="CloseTable" class="table table-hover table-bordered">
                        <thead>
                            <tr>
                                <th class="text-center">#</th>
                                <th class="text-center">عنوان حساب</th>
                                <th class="text-center">وضعیت</th>
                                <th class="text-center">عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-center">1</td>
                                <td class="text-center">صندوق ها</td>
                                <td class="text-center">
                                    <span id="status" class="label label-outline-danger">حساب باز است</span>
                                </td>
                                <td class="text-center">
                                    <span id="CashDesk" value="1" status="0" class="label label-outline-danger" style="cursor:pointer;text-decoration:none">بستن حساب</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-center">2</td>
                                <td class="text-center">بانک ها</td>
                                <td class="text-center">
                                    <span id="status" class="label label-outline-danger">حساب باز است</span>
                                </td>
                                <td class="text-center">
                                    <span id="Banks" value="2" status="0" class="label label-outline-danger" style="cursor:pointer;text-decoration:none">بستن حساب</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-center">3</td>
                                <td class="text-center">حساب اشخاص</td>
                                <td class="text-center">
                                    <span id="status" class="label label-outline-danger">حساب باز است</span>
                                </td>
                                <td class="text-center">
                                    <span id="HesabAshkhas" value="3" status="0" class="label label-outline-danger" style="cursor:pointer;text-decoration:none">بستن حساب</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-center">4</td>
                                <td class="text-center"> چک های دریافتی(اسناد دریافتنی)</td>
                                <td class="text-center">
                                    <span id="status" class="label label-outline-danger">حساب باز است</span>
                                </td>
                                <td class="text-center">
                                    <span id="ADaryaftani" value="4" status="0" class="label label-outline-danger" style="cursor:pointer;text-decoration:none">بستن حساب</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-center">5</td>
                                <td class="text-center">چک های در جریان وصول</td>
                                <td class="text-center">
                                    <span id="status" class="label label-outline-danger">حساب باز است</span>
                                </td>
                                <td class="text-center">
                                    <span id="Cheuqe" value="5" status="0" class="label label-outline-danger" style="cursor:pointer;text-decoration:none">بستن حساب</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-center">6</td>
                                <td class="text-center">حساب سرمایه اولیه</td>
                                <td class="text-center">
                                    <span id="status" class="label label-outline-danger">حساب باز است</span>
                                </td>
                                <td class="text-center">
                                    <span id="Sarmayeh" value="6" status="0" class="label label-outline-danger" style="cursor:pointer;text-decoration:none">بستن حساب</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-center">7</td>
                                <td class="text-center">سایر دارایی ها</td>
                                <td class="text-center">
                                    <span id="status" class="label label-outline-danger">حساب باز است</span>
                                </td>
                                <td class="text-center">
                                    <span id="OtherDara" value="7" status="0" class="label label-outline-danger" style="cursor:pointer;text-decoration:none">بستن حساب</span>
                                </td>
                            </tr>

                            <tr>
                                <td class="text-center">8</td>
                                <td class="text-center"> چک های پرداختی(اسناد پرداختنی)</td>
                                <td class="text-center">
                                    <span id="status" class="label label-outline-danger">حساب باز است</span>
                                </td>
                                <td class="text-center">
                                    <span id="APardakhtani" value="8" status="0" class="label label-outline-danger" style="cursor:pointer;text-decoration:none">بستن حساب</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-center">9</td>
                                <td class="text-center">سایر بدهی ها</td>
                                <td class="text-center">
                                    <span id="status" class="label label-outline-danger">حساب باز است</span>
                                </td>
                                <td class="text-center">
                                    <span id="OtherBedehi" value="9" status="0" class="label label-outline-danger" style="cursor:pointer;text-decoration:none">بستن حساب</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="col-xs-12 col-md-12" style="border-bottom:1px solid #ddd ; margin-top:20px"></div>
    <div class="col-xs-12 col-md-12 text-center">
        <input id="CloseFinanceYear" disabled class="btn btn-success" type="submit" value="بستن دوره مالی و ایجاد دوره مالی جدید" style="margin-top:20px" />
    </div>
</div>
@section toastr{
    @Html.Raw(TempData["saveMassage"])
}
@section styles{
    <link href="~/Scripts/PersianDateTimePicker/jquery-ui-datetimepicker.min.css" rel="stylesheet" />
}
@section scripts{
    <script src="~/Scripts/PersianDateTimePicker/jquery-ui-datetimepicker.min.js"></script>
    <script>
        var step = 1;
        //CashDesk
        $(document).on("click", "#CloseTable tr td span#CashDesk", function () {
            var Row = $(this).closest('tr');
            var value = $(this).attr("value");
            var status = $(this).attr("status");
            if (status == 0) {
                if (value == step) {
                    $.ajax({
                        url: "/FiscalYearOp/CashDeskFiscalYearOp",
                        data: { FiscalId: $("#CurrentFiscalId").val() },
                        type: "Post",
                        dataType: "Json",
                        success: function (result) {
                            if (result.Success) {
                                Row.find('td').find('span#CashDesk').removeClass("label-outline-danger");
                                Row.find('td').find('span#CashDesk').addClass("label-outline-success");
                                var s = Row.find('td').find('span#status');
                                s.removeClass("label-outline-danger");
                                s.addClass("label-outline-success");
                                s.text("حساب بسته شد");
                                step = step + 1;
                                Row.find('td').find('span#CashDesk').attr("status", 1);


                            }
                            Toast(result.Script);
                        },
                        error: function () {
                            alert("خطا!");
                        }
                    });
                }
                else {
                    Toast("لطفا در بستن حساب ها ترتیب را رعایت فرمایید,info");
                }
            }
            else {

                Toast("این حساب با موفقیت بسته شده است,info");
            }
        });
        //Bank
        $(document).on("click", "#CloseTable tr td span#Banks", function () {
            var Row = $(this).closest('tr');
            var value = $(this).attr("value");
            var status = $(this).attr("status");
            if (status == 0) {
                if (value == step) {
                    $.ajax({
                        url: "/FiscalYearOp/BankFiscalYearOp",
                        data: { FiscalId: $("#CurrentFiscalId").val() },
                        type: "Post",
                        dataType: "Json",
                        success: function (result) {
                            if (result.Success) {
                                Row.find('td').find('span#Banks').removeClass("label-outline-danger");
                                Row.find('td').find('span#Banks').addClass("label-outline-success");
                                var s = Row.find('td').find('span#status');
                                s.removeClass("label-outline-danger");
                                s.addClass("label-outline-success");
                                s.text("حساب بسته شد");
                                step = step + 1;
                                Row.find('td').find('span#Banks').attr("status", 1);


                            }
                            Toast(result.Script);
                        },
                        error: function () {
                            alert("خطا!");
                        }
                    });
                }
                else {
                    Toast("لطفا در بستن حساب ها ترتیب را رعایت فرمایید,info");
                }
            }
            else {

                Toast("این حساب با موفقیت بسته شده است,info");
            }
        });
        //HesabAshkhas
        $(document).on("click", "#CloseTable tr td span#HesabAshkhas", function () {
            var Row = $(this).closest('tr');
            var value = $(this).attr("value");
            var status = $(this).attr("status");
            if (status == 0) {
                if (value == step) {
                    $.ajax({
                        url: "/FiscalYearOp/HesabAshkhasFiscalYearOp",
                        data: { FiscalId: $("#CurrentFiscalId").val() },
                        type: "Post",
                        dataType: "Json",
                        success: function (result) {
                            if (result.Success) {
                                Row.find('td').find('span#HesabAshkhas').removeClass("label-outline-danger");
                                Row.find('td').find('span#HesabAshkhas').addClass("label-outline-success");
                                var s = Row.find('td').find('span#status');
                                s.removeClass("label-outline-danger");
                                s.addClass("label-outline-success");
                                s.text("حساب بسته شد");
                                step = step + 1;
                                Row.find('td').find('span#HesabAshkhas').attr("status", 1);


                            }
                            Toast(result.Script);
                        },
                        error: function () {
                            alert("خطا!");
                        }
                    });
                }
                else {
                    Toast("لطفا در بستن حساب ها ترتیب را رعایت فرمایید,info");
                }
            }
            else {

                Toast("این حساب با موفقیت بسته شده است,info");
            }
        });
        //AsnadDaryftani
        $(document).on("click", "#CloseTable tr td span#ADaryaftani", function () {
            var Row = $(this).closest('tr');
            var value = $(this).attr("value");
            var status = $(this).attr("status");
            if (status == 0) {
                if (value == step) {
                    $.ajax({
                        url: "/FiscalYearOp/AsnadDaryaftaniFiscalYearOp",
                        data: { FiscalId: $("#CurrentFiscalId").val() },
                        type: "Post",
                        dataType: "Json",
                        success: function (result) {
                            if (result.Success) {
                                Row.find('td').find('span#ADaryaftani').removeClass("label-outline-danger");
                                Row.find('td').find('span#ADaryaftani').addClass("label-outline-success");
                                var s = Row.find('td').find('span#status');
                                s.removeClass("label-outline-danger");
                                s.addClass("label-outline-success");
                                s.text("حساب بسته شد");
                                step = step + 1;
                                Row.find('td').find('span#ADaryaftani').attr("status", 1);


                            }
                            Toast(result.Script);
                        },
                        error: function () {
                            alert("خطا!");
                        }
                    });
                }
                else {
                    Toast("لطفا در بستن حساب ها ترتیب را رعایت فرمایید,info");
                }
            }
            else {

                Toast("این حساب با موفقیت بسته شده است,info");
            }
        });
        //ChequeDarjarayan
        $(document).on("click", "#CloseTable tr td span#Cheuqe", function () {
            var Row = $(this).closest('tr');
            var value = $(this).attr("value");
            var status = $(this).attr("status");
            if (status == 0) {
                if (value == step) {
                    $.ajax({
                        url: "/FiscalYearOp/ChequeDarJarayanFiscalYearOp",
                        data: { FiscalId: $("#CurrentFiscalId").val() },
                        type: "Post",
                        dataType: "Json",
                        success: function (result) {
                            if (result.Success) {
                                Row.find('td').find('span#Cheuqe').removeClass("label-outline-danger");
                                Row.find('td').find('span#Cheuqe').addClass("label-outline-success");
                                var s = Row.find('td').find('span#status');
                                s.removeClass("label-outline-danger");
                                s.addClass("label-outline-success");
                                s.text("حساب بسته شد");
                                step = step + 1;
                                Row.find('td').find('span#Cheuqe').attr("status", 1);


                            }
                            Toast(result.Script);
                        },
                        error: function () {
                            alert("خطا!");
                        }
                    });
                }
                else {
                    Toast("لطفا در بستن حساب ها ترتیب را رعایت فرمایید,info");
                }
            }
            else {

                Toast("این حساب با موفقیت بسته شده است,info");
            }
        });
   
        //Sarmayeh
        $(document).on("click", "#CloseTable tr td span#Sarmayeh", function () {
            var Row = $(this).closest('tr');
            var value = $(this).attr("value");
            var status = $(this).attr("status");
            if (status == 0) {
                if (value == step) {
                    $.ajax({
                        url: "/FiscalYearOp/HesabSarmayehFiscalYearOp",
                        data: { FiscalId: $("#CurrentFiscalId").val() },
                        type: "Post",
                        dataType: "Json",
                        success: function (result) {
                            if (result.Success) {
                                Row.find('td').find('span#Sarmayeh').removeClass("label-outline-danger");
                                Row.find('td').find('span#Sarmayeh').addClass("label-outline-success");
                                var s = Row.find('td').find('span#status');
                                s.removeClass("label-outline-danger");
                                s.addClass("label-outline-success");
                                s.text("حساب بسته شد");
                                step = step + 1;
                                Row.find('td').find('span#Sarmayeh').attr("status", 1);


                            }
                            Toast(result.Script);
                        },
                        error: function () {
                            alert("خطا!");
                        }
                    });
                }
                else {
                    Toast("لطفا در بستن حساب ها ترتیب را رعایت فرمایید,info");
                }
            }
            else {

                Toast("این حساب با موفقیت بسته شده است,info");
            }
        });
        //OtherDara
        $(document).on("click", "#CloseTable tr td span#OtherDara", function () {
            var Row = $(this).closest('tr');
            var value = $(this).attr("value");
            var status = $(this).attr("status");
            if (status == 0) {
                if (value == step) {
                    $.ajax({
                        url: "/FiscalYearOp/OtherDaraeiFiscaYearOp",
                        data: { FiscalId: $("#CurrentFiscalId").val() },
                        type: "Post",
                        dataType: "Json",
                        success: function (result) {
                            if (result.Success) {
                                Row.find('td').find('span#OtherDara').removeClass("label-outline-danger");
                                Row.find('td').find('span#OtherDara').addClass("label-outline-success");
                                var s = Row.find('td').find('span#status');
                                s.removeClass("label-outline-danger");
                                s.addClass("label-outline-success");
                                s.text("حساب بسته شد");
                                step = step + 1;
                                Row.find('td').find('span#OtherDara').attr("status", 1);


                            }
                            Toast(result.Script);
                        },
                        error: function () {
                            alert("خطا!");
                        }
                    });
                }
                else {
                    Toast("لطفا در بستن حساب ها ترتیب را رعایت فرمایید,info");
                }
            }
            else {

                Toast("این حساب با موفقیت بسته شده است,info");
            }
        });
        //AsnadPardakhtani
        $(document).on("click", "#CloseTable tr td span#APardakhtani", function () {
            var Row = $(this).closest('tr');
            var value = $(this).attr("value");
            var status = $(this).attr("status");
            if (status == 0) {
                if (value == step) {
                    $.ajax({
                        url: "/FiscalYearOp/AsnadPardakhtaniFiscalYearOp",
                        data: { FiscalId: $("#CurrentFiscalId").val() },
                        type: "Post",
                        dataType: "Json",
                        success: function (result) {
                            if (result.Success) {
                                Row.find('td').find('span#APardakhtani').removeClass("label-outline-danger");
                                Row.find('td').find('span#APardakhtani').addClass("label-outline-success");
                                var s = Row.find('td').find('span#status');
                                s.removeClass("label-outline-danger");
                                s.addClass("label-outline-success");
                                s.text("حساب بسته شد");
                                step = step + 1;
                                Row.find('td').find('span#APardakhtani').attr("status", 1);


                            }
                            Toast(result.Script);
                        },
                        error: function () {
                            alert("خطا!");
                        }
                    });
                }
                else {
                    Toast("لطفا در بستن حساب ها ترتیب را رعایت فرمایید,info");
                }
            }
            else {

                Toast("این حساب با موفقیت بسته شده است,info");
            }
        });
        //OtherBedhi
        $(document).on("click", "#CloseTable tr td span#OtherBedehi", function () {
            var Row = $(this).closest('tr');
            var value = $(this).attr("value");
            var status = $(this).attr("status");
            if (status == 0) {
                if (value == step) {
                    $.ajax({
                        url: "/FiscalYearOp/OtherBedhiFiscaYearOp",
                        data: { FiscalId: $("#CurrentFiscalId").val() },
                        type: "Post",
                        dataType: "Json",
                        success: function (result) {
                            if (result.Success) {
                                Row.find('td').find('span#OtherBedehi').removeClass("label-outline-danger");
                                Row.find('td').find('span#OtherBedehi').addClass("label-outline-success");
                                var s = Row.find('td').find('span#status');
                                s.removeClass("label-outline-danger");
                                s.addClass("label-outline-success");
                                s.text("حساب بسته شد");
                                step = step + 1;
                                Row.find('td').find('span#OtherBedehi').attr("status", 1);
                                if (value == 9) {
                                    $("#CloseFinanceYear").removeAttr("disabled");
                                }

                            }
                            Toast(result.Script);
                        },
                        error: function () {
                            alert("خطا!");
                        }
                    });
                }
                else {
                    Toast("لطفا در بستن حساب ها ترتیب را رعایت فرمایید,info");
                }
            }
            else {

                Toast("این حساب با موفقیت بسته شده است,info");
            }
        });

        //initiateDate
        $(document).on("ready", function () {

            $("#EndDate").datepicker({
                beforeShow: function (input, inst) {
                    var cal = inst.dpDiv;
                    var left = $(this).offset().left;
                    setTimeout(function () {
                        cal.css({
                            'left': left
                        });
                    }, 10);
                },

                onSelect: function (dateStr) {
                    var st = $("#StartDate").val();
                    if (CheckDate(st, dateStr)) {
                        var FiscalName = "سال مالی منتهی به" + " " + dateStr;
                        $("#NewFiscalYear").val(FiscalName);
                    }
                    else {
                        $("#EndDate").val("");
                        $("#NewFiscalYear").val("");
                    }
                },
                changeMonth: true,
            });

            function CheckDate(startDate, EndDate) {
                var d1 = startDate.split('/');
                var d2 = EndDate.split('/');
                if (d2[0] > d1[0]) {
                    return true;
                }
                else if (d2[0] == d1[0] && d2[1] > d1[1]) {
                    return true;
                }
                else if (d2[0] == d1[0] && d2[1] == d1[1] && d2[2] > d1[1]) {
                    return true;
                }
                else {
                    return false;
                }
            }
        });

        //FinallClose
        $(document).on("click", "#CloseFinanceYear", function () {

            if ($("#StartDate").val() != "" && $("#EndDate").val() != "" && $("#CurrentFiscalId").val() != "" && $("#NewFiscalYear").val() != "") {
                $.ajax({
                    url: "/FiscalYearOp/CloseFinanceYear",
                    data: { startDate: $("#StartDate").val(), EndDate: $("#EndDate").val(), FiscalId: $("#CurrentFiscalId").val(), FiscalName: $("#NewFiscalYear").val() },
                    type: "Post",
                    dataType: "Json",
                    success: function (result) {
                        if (result.Success) {
                            window.location.href = result.Html;
                        }
                        Toast(result.Script);
                    },
                    error: function () {
                        alert("خطا!");
                    }
                });
            }
            else {
                Toast('اطلاعات سال مالی تازه را واردنمایید,info');
            }
        
        });
    </script>

}


